#!/bin/bash

HS_FILES=$(git diff --name-only --diff-filter=ACMR HEAD "*.hs")

if ! which ormolu >& /dev/null; then
  echo "Could not find 'ormolu', is it installed?"
  exit 1
fi

BAD_HS_FILES=""

for file in $HS_FILES; do
  if ! ormolu -m check -o '-XTypeApplications' -o '-XOverloadedRecordDot' -o '-XOverloadedRecordUpdate' "${file}"; then
    BAD_HS_FILES+=" ${file}"
    ORMOLU_FAIL="true"
  fi
done

if [ -n "$ORMOLU_FAIL" ]; then
  ORMOLU_CMD="ormolu -m inplace -o -XTypeApplications -o -XOverloadedRecordDot -o -XOverloadedRecordUpdate ${BAD_HS_FILES}"
  echo "Code style issues found in:"
  echo "${BAD_HS_FILES}"

  if [ -n "$BECKN_DISABLE_AUTOFORMAT" ]; then
    echo "Fix them with:"
    echo " ${ORMOLU_CMD}"
  else
    echo "Running Ormolu, please check and git add the changes"
    ${ORMOLU_CMD}
  fi
fi

if [ -n "$ORMOLU_FAIL" ]; then
  exit 1
fi

for MODULE in $(ls dev/migrations); do
  MIGRATION_DIR="dev/migrations/${MODULE}"
  if [ $(ls ${MIGRATION_DIR} | cut -c-4 | uniq | wc -l) != $(ls ${MIGRATION_DIR} | wc -l) ]; then
    echo "There are overlapping migration indices in ${MODULE}"
    exit 1
  fi
done

DHALL_FILES=$(git diff --name-only --diff-filter=ACMR HEAD "*.dhall")

if ! which dhall >& /dev/null; then
  echo "Could not find 'dhall', is it installed?"
  exit 1
fi

for file in $DHALL_FILES; do
  if ! dhall --file "${file}" 1>/dev/null; then
    BAD_DHALL_FILES+=" ${file}"
    DHALL_FAIL="true"
  fi
done

if [ -n "$DHALL_FAIL" ]; then
  echo "Invalid dhall files:"
  echo "${BAD_DHALL_FILES}"
  exit 1
fi

exit 0
