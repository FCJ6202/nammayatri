imports:
  VehicleCategory: BecknV2.FRFS.Enums
  Merchant: Domain.Types.Merchant
  MerchantOperatingCity: Domain.Types.MerchantOperatingCity
  RawDataType: Domain.Types.Extra.Rollout

Rollout:
  tableName: rollout

  fields:
    id: Id Rollout
    vehicleType: VehicleCategory
    inputDataType: RawDataType
    versionTag: Int
    percentageRollout: Int

  queries:
    findByMerchantOperatingCityAndVehicleType:
      kvFunction: findOneWithKV
      where:
        and: [merchantOperatingCityId, vehicleType]
    findAllByMerchantOperatingCityAndVehicleType:
      kvFunction: findAllWithKV
      where:
        and: [merchantOperatingCityId, vehicleType]
    updateByMerchantOperatingCityAndVehicleType:
      kvFunction: updateWithKV
      params: [percentageRollout]
      where:
        and: [merchantOperatingCityId, vehicleType]
    deleteByVersionId:
      kvFunction: deleteWithKV
      where: id

  cachedQueries:
    findAllByMerchantOperatingCityAndVehicleType:
      keyParams: [merchantOperatingCityId, vehicleType]
      dbQuery: findAllByMerchantOperatingCityAndVehicleType
      dbQueryParams: [merchantOperatingCityId, vehicleType]
      queryType: FindAndCache

  extraOperations:
    - EXTRA_DOMAIN_TYPE_FILE

Stage:
  tableName: stage

  types:
    StageName:
      enum: "PREPROCESSING,VALIDATION,UPLOAD"

  fields:
    id: Id Stage
    vehicleType: VehicleCategory
    inputDataType: RawDataType
    name: StageName
    order: Int


  queries:
    findByMerchantOperatingCityAndVehicleType:
      kvFunction: findAllWithKV
      where:
        and: [merchantOperatingCityId, vehicleType]
    findByMerchantOperatingCityAndVehicleTypeAndInputDataType:
      kvFunction: findAllWithKV
      where:
        and: [merchantOperatingCityId, vehicleType, inputDataType]
    findByMerchantOperatingCityAndVehicleTypeAndStageName:
      kvFunction: findOneWithKV
      where:
        and: [merchantOperatingCityId, vehicleType, name]

Version:
  tableName: version

  fields:
    id: Id Version
    vehicleType: VehicleCategory
    inputDataType: RawDataType
    versionTag: Int
    isReadyToApply: Bool
    gtfsLink: Maybe Text # S3 path

  queries:
    findAllByMerchantOperatingCityAndVehicleTypeAndDataType:
      kvFunction: findAllWithKV
      where:
        and: [merchantOperatingCityId, vehicleType, inputDataType]
    findAllReadyToApplyByMerchantOperatingCityAndVehicleTypeAndDataType:
      kvFunction: findAllWithKV
      where:
        and: [isReadyToApply, merchantOperatingCityId, vehicleType, inputDataType]

  cachedQueries:
    findAllReadyToApplyByMerchantOperatingCityAndVehicleTypeAndDataType:
      keyParams: [merchantOperatingCityId, vehicleType, inputDataType]
      dbQuery: findAllReadyToApplyByMerchantOperatingCityAndVehicleTypeAndDataType
      dbQueryParams: [isReadyToApply, merchantOperatingCityId, vehicleType, inputDataType]
      queryType: FindAndCache

VersionStageMapping:
  tableName: version_stage_mapping

  types:
    Status:
      enum: "Inprogress,Completed,Failed"
    StageData:
      enum: "GTFSData GtfsDataType,FAREData FareDataType"
    GtfsDataType:
      - gtfsFilePath: Maybe Text
      - customFilePath: Maybe Text
      - derive: "Read, Eq, Ord"
    FareDataType:
      - id: Text
      - derive: "Read, Eq, Ord"


  fields:
    id: Id VersionStageMapping
    versionId: Text
    stageId: Text
    status: Status
    stageData: Maybe StageData # (GTFS GtfsDataType | FARE FareDataType)
    failureReason: Maybe Text
    stageName: Text



  queries:
    findByVersionIdAndStageId:
      kvFunction: findOneWithKV
      where:
        and: [versionId, stageId]
    findAllByVersionId:
      kvFunction: findAllWithKV
      where: versionId
    updateFailureById:
      kvFunction: updateWithKV
      params: [failureReason, status]
      where: id
    updateSuccessById:
      kvFunction: updateWithKV
      params: [status]
      where: id

  excludedFields: [merchantOperatingCityId, merchantId]