# @name healthcheck

@empty =
@clickhouse-kafka = http://localhost:8123
@clickhouse-password = {{empty}}

@merchantId = favorit-auto1-0000000000000000000000

@driverId = favorit-auto1-0000000000000000000000

@dashboardToken = 0f3378e2-da5b-4eac-a0f6-397ca48358de

@dbName = atlas_kafka

GET {{clickhouse-kafka}}

###

# @name version

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

Select version()

###

# @name testQuery

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

Select 1;

###

# @name createDriverEdaKafkaTable

# Nullable column (e.g. Nullable(String)) creates a separate column of UInt8 type. This additional column has to be processed every time a user works with a nullable column. This leads to additional storage space used and almost always negatively affects performance.
# To avoid Nullable columns, consider setting a default value for that column.

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

CREATE TABLE {{dbName}}.driver_eda_kafka
( `driver_id` String,
  `rid` Nullable(String),
  `ts` DateTime64(3) DEFAULT now(),
  `acc` Nullable(String),
  `rideStatus` Nullable(String),
  `lat` Nullable(String),
  `lon` Nullable(String),
  `mid` Nullable(String),
  `updated_at` Nullable(String),
  `created_at` Nullable(String),
  `on_ride` Nullable(String),
  `active` Nullable(String),
  `partition_date` Date,
  `date` DateTime DEFAULT now()
)
ENGINE = MergeTree()
PRIMARY KEY (ts)

###

# @name insertDriverEdaKafkaTable

@rideId = e58307b0-9461-43a4-9a22-0cdcdc4ab774

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

INSERT INTO {{dbName}}.driver_eda_kafka
(driver_id,rid,ts,acc,rideStatus,lat,lon,mid,updated_at,created_at,on_ride,active,partition_date,date)
Values
( '{{driverId}}',
  '{{rideId}}',
  '2024-01-09 07:02:42.1',
  '3.900000095367432',
  'ON_PICKUP',
  '12.9104517',
  '77.6765917',
  'merchantId',
  null,
  null,
  '1',
  '1',
  '2024-01-26 07:02:42.932',
  '2024-01-26 07:02:42'
)

###

# @name selectAll

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

SELECT (*) from {{dbName}}.driver_eda_kafka
FORMAT JSON

###

# @name rideRoute

POST {{bpp-dashboard-host}}/bpp/driver-offer/NAMMA_YATRI_PARTNER/Kochi/ride/{{rideId}}/route
token: {{dashboardToken}}

###

# @name driverEdaKafka

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

SELECT
    lat as res1,
    lon as res2,
    ts as res3,
    acc as res4,
    rideStatus as res5
FROM
    {{dbName}}.driver_eda_kafka
WHERE
    (
        (
            (partition_date = '2024-01-26')
            OR (partition_date = '2024-01-27')
        )
        AND (
            (driver_id = 'favorit-auto1-0000000000000000000000')
            AND (rid = 'e58307b0-9461-43a4-9a22-0cdcdc4ab774')
        )
    )
ORDER BY
    ts ASC
FORMAT JSON

###

# @name deleteDriverEdaKafkaTable

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

DELETE FROM {{dbName}}.driver_eda_kafka WHERE True

###

# @name dropDriverEdaKafkaTable

POST {{clickhouse-kafka}}
Authorization: Basic default:{{clickhouse-password}}
content-type: text/html

DROP TABLE {{dbName}}.driver_eda_kafka
