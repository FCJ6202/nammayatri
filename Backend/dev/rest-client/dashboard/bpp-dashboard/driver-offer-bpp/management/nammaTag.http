# access tokens with different roles
@customer = {{bpp-dashboard/token/NAMMA_YATRI_PARTNER/customer}}
@driver = {{bpp-dashboard/token/NAMMA_YATRI_PARTNER/driver}}
@juspay_ops = {{bpp-dashboard/token/NAMMA_YATRI_PARTNER/juspay_ops}}
@juspay_admin = {{bpp-dashboard/token/NAMMA_YATRI_PARTNER/juspay_admin}}
@customer_service = {{bpp-dashboard/token/NAMMA_YATRI_PARTNER/customer_service}}

# @name healthcheck
GET {{bpp-dashboard-host}}

###

# @name dailyRidesQueryCreate

POST {{bpp-dashboard-host}}/bpp/driver-offer/NAMMA_YATRI_PARTNER/KOCHI/nammaTag/query/create
token: {{customer_service}}
content-type: application/json

# FIXME use templates:
# SELECT driver_id as userId, count(id) as totalRides, sum(chargeable_distance) as totalDistance, sum(fare) as totalFare
#   FROM atlas_driver_offer_bpp.ride
#   WHERE (created_at > now AND created_at > now - {period})
#   GROUP BY driver_id
#   LIMIT {limit}
#   OFFSET {offset}

{
    "chakra": "Daily",
    "queryName" : "dailyRides",
    "queryResults": ["userId", "totalRides", "totalDistance", "totalFare"],
    "queryText": "SELECT driver_id as userId, count(id) :: int as totalRides, sum(chargeable_distance) :: int as totalDistance, sum(fare) :: int as totalFare FROM atlas_driver_offer_bpp.ride WHERE created_at > '2024-01-01 00:00:00' GROUP BY driver_id"
}

###

# @name dailyCancellationsQueryCreate

POST {{bpp-dashboard-host}}/bpp/driver-offer/NAMMA_YATRI_PARTNER/KOCHI/nammaTag/query/create
token: {{customer_service}}
content-type: application/json

{
    "chakra": "Daily",
    "queryName" : "dailyCancellations",
    "queryResults": ["userId", "cancellationsCount"],
    "queryText": "SELECT driver_id as userId, count(id) :: int as cancellationsCount FROM atlas_driver_offer_bpp.ride WHERE created_at > '2024-01-01 00:00:00' AND status = 'CANCELLED' GROUP BY driver_id"
}

###

# @name DriverSpeedTagCreate

POST {{bpp-dashboard-host}}/bpp/driver-offer/NAMMA_YATRI_PARTNER/KOCHI/nammaTag/tag/create
token: {{customer_service}}
content-type: application/json

{
  "tag": "KaalChakraTag",
  "contents": {
    "tagCategory": "DriverTags",
    "tagName": "DriverSpeed",
    "description": "",
    "tagPossibleValues": {
      "tag": "Tags",
      "contents": [
        "FAST_DRIVER",
        "SLOW_DRIVER"
      ]
    },
    "tagChakra": "Daily",
    "tagValidity": 24,
    "tagRule": {
      "tag": "RuleEngine",
      "contents": {
        "if": [
          {
            "and": [
              {
                ">=": [
                  {
                    "var": "dailyRides.totalRides"
                  },
                  2
                ]
              },
              {
                ">=": [
                  {
                    "var": "dailyRides.totalDistance"
                  },
                  100
                ]
              },
              {
                "<=": [
                  {
                    "var": "dailyCancellations.cancellationsCount"
                  },
                  2
                ]
              }
            ]
          },
          "FAST_DRIVER",
          "SLOW_DRIVER"
        ]
      }
    }
  }
}

###

# @name runKaalChakraJob

POST {{bpp-dashboard-host}}/bpp/driver-offer/NAMMA_YATRI_PARTNER/KOCHI/nammaTag/runJob
token: {{customer_service}}
content-type: application/json

{
    "chakra": "Daily"
}
